<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Actual Auto Backup</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <h1 class="h4 mb-3">Actual Auto Backup</h1>
              <p class="text-muted mb-4">
                Manage backup destinations and trigger ad-hoc exports.
              </p>

              <div id="alert" class="alert d-none" role="alert"></div>

              <section class="mb-4">
                <h2 class="h6">Backup Destinations</h2>
                <div class="list-group" id="destinationList"></div>
              </section>

              <section class="mb-4">
                <h2 class="h6">Manual Backup</h2>
                <button id="backupBtn" class="btn btn-primary">
                  Run Backup Now
                </button>
              </section>

              <small class="text-muted">
                Backups run on schedule and are saved locally to
                <code>/app/data/backups</code> when enabled. Cloud destinations
                require linking below.
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const destinationList = document.getElementById("destinationList");
      const alertBox = document.getElementById("alert");
      const backupBtn = document.getElementById("backupBtn");

      function showAlert(message, type = "info") {
        alertBox.textContent = message;
        alertBox.className = `alert alert-${type}`;
        alertBox.classList.remove("d-none");
      }

      function hideAlert() {
        alertBox.classList.add("d-none");
      }

      async function loadStatus() {
        try {
          const res = await fetch("/api/status");
          if (!res.ok) throw new Error("status request failed");
          const { status, running } = await res.json();
          renderDestinations(status);
          backupBtn.disabled = running;
          hideAlert();
        } catch (err) {
          showAlert(`Failed to load status: ${err.message}`, "danger");
        }
      }

      function createDestinationItem({
        id,
        label,
        linked,
        enabled,
        linkUrl,
        unlinkAction,
        extra,
      }) {
        const item = document.createElement("div");
        item.className =
          "list-group-item d-flex justify-content-between align-items-center flex-wrap";
        const text = document.createElement("div");
        text.innerHTML = `<strong>${label}</strong><br />
          <small class="text-muted">${
            enabled ? (linked ? "Linked" : "Not linked") : "Disabled"
          }</small>`;
        item.appendChild(text);
        const actions = document.createElement("div");
        if (enabled && linkUrl && !linked) {
          const linkBtn = document.createElement("a");
          linkBtn.className = "btn btn-sm btn-success me-2";
          linkBtn.href = linkUrl;
          linkBtn.textContent = "Link";
          actions.appendChild(linkBtn);
        }
        if (enabled && linked && unlinkAction) {
          const unlinkBtn = document.createElement("button");
          unlinkBtn.className = "btn btn-sm btn-outline-danger me-2";
          unlinkBtn.textContent = "Unlink";
          unlinkBtn.onclick = () => unlinkAction(id);
          actions.appendChild(unlinkBtn);
        }
        if (extra) {
          const span = document.createElement("span");
          span.className = "badge bg-secondary";
          span.textContent = extra;
          actions.appendChild(span);
        }
        item.appendChild(actions);
        return item;
      }

      function renderDestinations(status) {
        destinationList.innerHTML = "";
        const entries = [
          {
            id: "local",
            label: "Local storage",
            enabled: status.local.enabled,
            linked: status.local.enabled,
            extra: status.local.enabled ? "Enabled" : "Disabled",
          },
          {
            id: "google",
            label: "Google Drive",
            enabled: status.google.enabled,
            linked: status.google.linked,
            linkUrl:
              status.google.enabled && status.google.mode === "oauth"
                ? "/auth/google"
                : null,
            unlinkAction: unlinkProvider,
            extra:
              status.google.mode === "oauth"
                ? "OAuth"
                : status.google.enabled
                  ? "Service account"
                  : null,
          },
          {
            id: "dropbox",
            label: "Dropbox",
            enabled: status.dropbox.enabled,
            linked: status.dropbox.linked,
            linkUrl: status.dropbox.enabled ? "/auth/dropbox" : null,
            unlinkAction: unlinkProvider,
          },
          {
            id: "s3",
            label: "S3 / compatible",
            enabled: status.s3.enabled,
            linked: status.s3.enabled,
            extra: status.s3.enabled ? "Configured" : "Disabled",
          },
          {
            id: "webdav",
            label: "WebDAV / Nextcloud",
            enabled: status.webdav.enabled,
            linked: status.webdav.enabled,
            extra: status.webdav.enabled ? "Configured" : "Disabled",
          },
        ];
        entries.forEach((entry) => {
          destinationList.appendChild(createDestinationItem(entry));
        });
      }

      async function unlinkProvider(provider) {
        try {
          const res = await fetch(`/api/${provider}/unlink`, {
            method: "POST",
          });
          if (!res.ok) throw new Error("unlink failed");
          await loadStatus();
          showAlert(`${provider} unlinked`, "success");
        } catch (err) {
          showAlert(`Failed to unlink ${provider}: ${err.message}`, "danger");
        }
      }

      backupBtn.addEventListener("click", async () => {
        backupBtn.disabled = true;
        showAlert("Running backup...", "info");
        try {
          const res = await fetch("/api/backup", { method: "POST" });
          if (!res.ok) {
            const json = await res.json().catch(() => ({}));
            throw new Error(json.error || "backup failed");
          }
          showAlert("Backup completed successfully", "success");
        } catch (err) {
          showAlert(`Backup failed: ${err.message}`, "danger");
        } finally {
          backupBtn.disabled = false;
        }
      });

      loadStatus();
    </script>
  </body>
</html>
